<%!
# retrieve settings
isLite = (cherrypy.config['product_type'] == 'lite' or cherrypy.config['product_type'] == 'lite_free')

if cherrypy.config['product_type'] == 'hunk':
    faviconFile = 'favicon_hunk.ico'
elif isLite:
    faviconFile = 'favicon_lite.ico'
else:
    faviconFile = 'favicon.ico'

faviconFilePath = '/static/img/' + faviconFile

config_qs = dict(autoload=1)
if hasattr(cherrypy.request, 'embed') and cherrypy.request.embed:
    config_qs['embed'] = 1
%>\

<%
''' Page-level execution. Executed once per load '''
minify_js = splunk.util.normalizeBoolean(cherrypy.config.get('minify_js'))
minify_css = splunk.util.normalizeBoolean(cherrypy.config.get('minify_css'))

app_name = app

splk_root = "/static"
splk_css_build = splk_root + "/css/build"
splk_js = splk_root + "/js"
splk_js_contrib = splk_js + "/contrib"
splk_js_profiles = splk_js + "/profiles"

app_root = "/".join([splk_root,"app",app_name])
app_img = app_root + "/img"

app_js = app_root + '/js'
app_js_pages = app_js + "/pages"
app_js_profiles = app_js + "/profiles"
app_js_contrib = app_js + '/contrib'

app_less = app_root + "/less"

app_js_build = app_root + '/js/build'
app_css_build = app_root + '/css'

pageJSName = page+'_page'

# optimized js and css
# app_css ="%s/common.css" % app_css_build
app_css ="%s/%s.css" % (app_css_build, page)
splunk_css = "%s/bootstrap.min.css" % splk_css_build
page_css = "%s/pages/%s/bootstrap.css" % (app_css_build ,str(page))

page_common_js = "%s/common.js" % app_js_build
page_js = "%s/%s.js" % (app_js_build ,pageJSName)
page_less = "%s/pages/%s/bootstrap.less" % (app_less ,page)

%>\

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Configure</title>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>-->
</head>
<body>
    <h3>Configure Environment for Splunk Checker</h3>

    <form id="cluster_info">
        Cluster ID:<br>
        <input id="cluster_id" required><br>
        <!--The 'value' tag here seems not work!-->
        <input type="checkbox" id="enable_cluster" value="True" checked>Enable cluster<br>
        <div id="rf_sf">
        RF=<input type="number" min="1" id="rf" required>SF=<input type="number" min="1" id="sf" required><br>
        </div>
        <input type="checkbox" id="enable_shcluster" value="True" checked>Enable search head cluster<br>
        Please input splunk uri (e.g. https://systest-auto-idx1:1901):<br>
        <input id="splunk_uri" type="url" required><br>
        Username:<br>
        <input id="username" required><br>
        Password:<br>
        <input id="password" required><br>
        Role:<br>
        <select id="role_select">
            <option selected disabled hidden style='display: none' value=''></option>
            <option value="master">Master</option>
            <option value="indexer">Indexer</option>
            <option value="searchhead">Search Head</option>
            <option value="forwarder">Forwarder</option>
        </select><br>
        <input type="submit" id="add_peer_btn" value="Add Peer!">
    </form>

    <!--Splunk will put the files under appserver/static/ to someplace like this-->
    <!--<script src="/static/app/splunk-checker/configuration.js"></script>-->
    <script src="${make_url('/config', _qs=config_qs)}"></script>
    <script src="${make_url('/static/js/i18n.js')}"></script>
    <script src="${make_url('/i18ncatalog?autoload=1')}"></script>
    <script src="${make_url(splk_js_contrib + '/require.js')}"></script>
    <script src="${make_url(splk_js_profiles + '/shared.js')}"></script>
    <script>
        require.config({
            baseUrl: "${make_url('/static/js')}",
            shim: {
                'bootstrap': {
                    deps: ['jquery']
                },
                'select2': {
                    deps: ['jquery']
                }
            },
            paths: {
                'app': '../app/${app_name}/js',
                'lib': '../app/${app_name}/js/lib',
                'bootstrap': '../app/${app_name}/bootstrap/js/bootstrap.min',
                'select2': '../app/${app_name}/js/lib/select2-3.5.2'
            },
            enforceDefine: false,
            // paths: {'app': '../app/${app_name}/js'},
            waitSeconds: 0
        });
    </script>
    <script>
        require(['jquery','splunkjs/mvc/headerview'], function($){
            $(document).ready(function(){
                $("#enable_cluster").click(function(){
                    $("#rf_sf").toggle(this.checked);
                    if (this.checked) {
                        this.value = "True";
                    }
                    else{
                        this.value = "False";
                    }
                });
                $("#enable_shcluster").click(function(){
                    if (this.checked) {
                        this.value = "True";
                    }
                    else{
                        this.value = "False";
                    }
                });

                // Display the stored cluster info.
                $.ajax({
                    url:"/en-US/splunkd/__raw/servicesNS/nobody/splunk-checker/splunk_checker/store_cluster_info?output_mode=json",
                    type: 'GET',
                    success: function (data){
                        //TODO: input validation.
                        for (var i=0; i < data.entry.length; ++i) {
                            var json_obj = JSON.parse(data.entry[i].content.cluster_info);
                            var output = JSON.stringify(json_obj, null, 4);
                            $("#info_list").append("<li><pre>"+output+"</pre></li>")
                        }
                    }
                });

                // Handle submit button.
                $("#add_peer_btn").click(function(){
                    // Valid inputs.
                    var check_inputs = [$('#cluster_id'), $('#rf'), $('#sf'), $('#splunk_uri'), $('#username'), $('#password')];
                    for (var i = 0, len = check_inputs.length; i<len; ++i) {
                        if (!check_inputs[i].val()){
                            return;
                        }
                    }
                    if (!$('#role_select').val()) {
                        alert('Please select the role!');
                        return;
                    }

                    // Send the info.
                    $.ajax({
                        url:"/en-US/splunkd/__raw/servicesNS/nobody/splunk-checker/splunk_checker/store_cluster_info?output_mode=json",
                        type: 'POST',
                        data: {
                            name: "test",
                            cluster_id: $("#cluster_id").val(),
                            enable_cluster: $("#enable_cluster").val(),
                            enable_shcluster: $("#enable_shcluster").val(),
                            replication_factor: $("#rf").val(),
                            search_factor: $("#sf").val(),
                            splunk_uri: $("#splunk_uri").val(),
                            username: $("#username").val(),
                            password: $("#password").val(),
                            role: $("#role_select").val()
                        }
                    });

                    // Set the inputs using localStorage.
                    localStorage.setItem("cluster_id", $("#cluster_id").val());
                    localStorage.setItem("enable_cluster", $("#enable_cluster").val());
                    localStorage.setItem("enable_shcluster", $("#enable_shcluster").val());
                    localStorage.setItem("rf", $("#rf").val());
                    localStorage.setItem("sf", $("#sf").val());
                });
                if (!localStorage.getItem("enable_cluster")){
                    localStorage.setItem("enable_cluster", "True");
                }
                if (!localStorage.getItem("enable_shcluster")){
                    localStorage.setItem("enable_shcluster", "True");
                }
                // Keep the input value after submit.
                $("#cluster_id").val(localStorage.getItem("cluster_id"));
                $("#enable_cluster").val(localStorage.getItem("enable_cluster"));
                $("#enable_shcluster").val(localStorage.getItem("enable_shcluster"));
                $("#rf").val(localStorage.getItem("rf"));
                $("#sf").val(localStorage.getItem("sf"));
            });
        });
    </script>
    <p id="add_success"></p>

    <p>Cluster Info from REST:</p>
    <ul id="info_list">
    </ul>
</body>
</html>
